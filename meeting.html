<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Convox Elite - Live Meeting</title>
  <script src="https://kit.fontawesome.com/a7b1b11b13.js" crossorigin="anonymous"></script>
  <script src="https://convox-themetup.onrender.com/socket.io/socket.io.js"></script>
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap"
  />
  <style>
    body {
  font-family: Montserrat, sans-serif;
  background: #121212;
  color: #f0f0f0;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
}
header.navbar {
  background-color: rgba(26, 26, 26, 0.8);
  backdrop-filter: blur(10px);
  padding: 0.75rem 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #333;
  flex-shrink: 0;
}
.logo {
  font-size: 1.5rem;
  font-weight: 700;
  color: #fff;
  font-family: "Playfair Display", serif;
}
.main-content {
  display: flex;
  flex-grow: 1;
  overflow: hidden;
}
.video-area {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  padding: 20px;
  overflow-y: auto;
}
.meeting-info {
  text-align: center;
  margin-bottom: 20px;
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.meeting-info h1 {
  font-size: 1.75rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
}
.meeting-info p {
  color: #aaa;
  display: flex;
  align-items: center;
  gap: 8px;
}
.copy-btn {
  background: none;
  border: none;
  color: #3498db;
  cursor: pointer;
  font-size: 1rem;
  transition: color 0.2s ease;
}
.copy-btn:hover {
  color: #2980b9;
}
.copy-btn.copied {
  color: #27ae60;
}
#video-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 15px;
  width: 100%;
}
.video-container {
  position: relative;
  background-color: #000;
  border-radius: 12px;
  overflow: hidden;
  border: 2px solid transparent;
  transition: border-color 0.3s ease;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
  aspect-ratio: 16 / 9;
}
.video-container:hover {
  border-color: #3498db;
}
video.video-participant {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}
.name-tag {
  position: absolute;
  bottom: 8px;
  left: 8px;
  background-color: rgba(0, 0, 0, 0.6);
  color: #fff;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.8rem;
  font-weight: 500;
  z-index: 10;
}
.audio-status {
  margin-right: 5px;
  color: #27ae60;
}
.audio-status.muted {
  color: #e74c3c;
}

/* -------- Stylish Sidebar & Content -------- */
.sidebar {
  background: linear-gradient(135deg, #191970 0%, #262626 100%);
  box-shadow: 0 2px 18px rgba(10,20,60,0.17);
  border-left: 1px solid #324076;
  display: flex;
  flex-direction: column;
  height: 100%;
}
.sidebar-content, .chat-box {
  flex: 1 1 50%;
  min-height: 0;
  max-height: 50vh;
  overflow-y: auto;
  padding: 1.1rem 0.9rem;
}
.sidebar-header, .chat-header {
  background: rgba(25, 25, 112, 0.33);
  border-radius: 8px 8px 0 0;
  margin-bottom: 0.4rem;
  padding-bottom: 0.3rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.sidebar-header h2, .chat-header span {
  color: #49aaff;
  letter-spacing: 1.2px;
  font-weight: 800;
  font-size: 1.22rem;
}
#participants-count {
  background: #1fadf6;
  color: #fff;
  font-size: 1.05rem;
  padding: 0 10px;
  margin-left: 8px;
  border-radius: 14px;
  font-weight: 700;
}
#participants-list {
  list-style: none;
  padding: 0;
  margin: 0;
}
#participants-list li {
  background: rgba(35,45,100,0.11);
  margin-bottom: 7px;
  padding: 8px 12px;
  border-radius: 6px;
  color: #e9e9ff;
  font-weight: 600;
  font-size: 1.0rem;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: 0 1px 6px rgba(20,30,60,0.07);
  border: none;
  transition: background 0.21s;
}
#participants-list li:hover {
  background: #2359af;
  color: #fff;
}
.messages {
  background: rgba(19,34,64,0.12);
  border-radius: 8px;
  margin-bottom: 4px;
  padding: 1.1rem 0.8rem;
  box-shadow: 0 1px 8px rgba(0,0,0,0.08);
  overflow-y: auto;
}
.message {
  margin-bottom: 0.75rem;
  background: #222;
  padding: 0.5rem;
  border-radius: 8px;
  font-size: 1.01rem;
}
.message .sender {
  font-weight: 700;
  color: #1fadf6;
  font-size: 0.92rem;
  margin-bottom: 4px;
  letter-spacing: .03em;
}
.chat-input {
  display: flex;
  padding: 1rem 0.1rem;
  background: #191970;
  border-top: 1px solid #333;
  border-radius: 0 0 8px 8px;
}
.chat-input input {
  background: #193155;
  color: #e0ecff;
  border: 1.5px solid #223f6a;
  font-size: 1.05rem;
  flex-grow: 1;
  border-radius: 6px;
  padding: 0.6rem 0.9rem;
  margin-right: 8px;
}
.chat-input button {
  background: #2bb6f9;
  font-weight: 700;
  border-radius: 8px;
  border: none;
  color: #fff;
  padding: 0.5rem 1.2rem;
  cursor: pointer;
  transition: background 0.2s;
}
.chat-input button:hover {
  background: #1fa1dd;
}
/* -------- Controls at bottom -------- */
.controls {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 1rem;
  background: rgba(30, 30, 30, 0.85);
  border-radius: 50px;
  padding: 0.75rem 1.5rem;
  border: 1px solid #444;
  z-index: 1000;
}
.controls button {
  background: #4b4b4b;
  border: none;
  width: 55px;
  height: 55px;
  border-radius: 50%;
  color: #fff;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}
.controls button:hover {
  background: #6a6a6a;
  transform: translateY(-3px);
}
/* Disabled style for controls */
.controls button:disabled {
  background: #2a2a2a;
  cursor: not-allowed;
  opacity: 0.6;
}
/* Controls for off-state e.g mic muted */
.controls button[aria-pressed="false"] {
  background-color: #cc3333;
}
.controls button[aria-pressed="false"]:hover {
  background-color: #e54545;
}
.controls .icon {
  font-size: 1.3rem;
  margin-bottom: 4px;
}
.controls .label {
  font-size: 0.6rem;
  font-weight: 600;
  text-transform: uppercase;
}
.end-call-btn {
  background: #e53e3e;
}
.end-call-btn:hover {
  background: #c53030;
}

  </style>
</head>
<body>
  <header class="navbar">
    <div class="logo">Convox Elite</div>
  </header>
  <div class="main-content">
    <main class="video-area">
      <div class="meeting-info">
        <h1>Live Meeting</h1>
        <p>
          Meeting ID: <strong id="meeting-id-display">NA</strong>
          <button id="copy-link-btn" class="copy-btn" title="Copy Meeting Link"
            ><i class="far fa-copy"></i></button
          >
        </p>
      </div>
      <div id="video-grid"></div>
    </main>
    <aside class="sidebar">
      <div class="sidebar-content " id="participants-section">
        <div class="sidebar-header">
          <h2>Participants <span id="participants-count" class="badge">0</span></h2>
          <button
            class="toggle-btn"
            id="toggle-participants-btn"
            title="Minimize/Maximize"
          >
            <i class="fas fa-chevron-up"></i>
          </button>
        </div>
        <ul id="participants-list"></ul>
      </div>
      <div class="chat-box " id="messages-section">
        <div class="chat-header">
          <span>Messages</span>
          <button class="toggle-btn" id="toggle-messages-btn" title="Minimize/Maximize">
            <i class="fas fa-chevron-up"></i>
          </button>
        </div>
        <div class="messages" id="chat-messages"></div>
        <div class="chat-input">
          <input type="text" id="chat-input" placeholder="Send a message..." />
          <button id="send-chat-btn">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </aside>
  </div>
  <div class="controls" role="toolbar" aria-label="Meeting controls">
    <button id="toggle-audio-btn" title="Toggle Audio" aria-pressed="true">
      <i id="audio-icon" class="fas fa-microphone icon"></i>
      <span id="audio-label" class="label">Mute</span>
    </button>
    <button id="toggle-video-btn" title="Toggle Video" aria-pressed="true">
      <i id="video-icon" class="fas fa-video icon"></i>
      <span id="video-label" class="label">Stop</span>
    </button>
    <button id="toggle-screen-share-btn" title="Screen Share" aria-pressed="false">
      <i id="screenshare-icon" class="fas fa-desktop icon"></i>
      <span id="screenshare-label" class="label">Share</span>
    </button>
    <button id="start-recording-btn" title="Start Recording" aria-pressed="false" disabled>
      <i id="recording-icon" class="fas fa-record-vinyl icon"></i>
      <span id="recording-label" class="label">Record</span>
    </button>
    <button id="end-call-btn" class="end-call-btn" title="End Call">
      <i class="fas fa-phone-slash icon"></i>
      <span class="label">End</span>
    </button>
  </div>

  <script>
    const socket = io("https://convox-themetup.onrender.com");
    const videoGrid = document.getElementById("video-grid");
    const myVideo = document.createElement("video");
    myVideo.muted = true;
    myVideo.id = "my-video";

    let localStream = null;
    let screenShareStream = null;
    let originalVideoTrack = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    let isRecording = false;
    let combinedStream = null;

    let participants = {};
    let peers = {};

    // Get meeting parameters from URL and localStorage
    const urlParams = new URLSearchParams(window.location.search);
    const meetingId = urlParams.get("id");
    const name = localStorage.getItem("userName") || "Guest";

    document.getElementById("meeting-id-display").textContent = meetingId ?? "NA";

    // Render participants list and update count
    function renderParticipants() {
      const participantsCount = Object.keys(participants).length;
      document.getElementById("participants-count").textContent = participantsCount;
      const participantsList = document.getElementById("participants-list");
      participantsList.innerHTML = "";
      Object.values(participants).forEach((u) => {
        const li = document.createElement("li");

        const audioIcon = document.createElement("i");
        audioIcon.classList.add("fas", u.isAudioMuted ? "fa-microphone-slash" : "fa-microphone");
        audioIcon.style.color = u.isAudioMuted ? "#e74c3c" : "#2ecc71";

        const videoIcon = document.createElement("i");
        videoIcon.classList.add("fas", u.isVideoMuted ? "fa-video-slash" : "fa-video");
        videoIcon.style.color = u.isVideoMuted ? "#e74c3c" : "#2ecc71";

        li.appendChild(audioIcon);
        li.appendChild(videoIcon);
        li.innerHTML += `<span class="name">${u.name}${u.socketId === socket.id ? " (You)" : ""}</span>`;

        participantsList.appendChild(li);
      });
    }

    // Toggle Participants and Messages sections
    document.getElementById("toggle-participants-btn").addEventListener("click", function () {
      const section = document.getElementById("participants-section");
      section.classList.toggle("collapsed");
      this.classList.toggle("collapsed");
      const icon = this.querySelector("i");
      icon.classList.toggle("fa-chevron-up");
      icon.classList.toggle("fa-chevron-down");
    });

    document.getElementById("toggle-messages-btn").addEventListener("click", function () {
      const section = document.getElementById("messages-section");
      section.classList.toggle("collapsed");
      this.classList.toggle("collapsed");
      const icon = this.querySelector("i");
      icon.classList.toggle("fa-chevron-up");
      icon.classList.toggle("fa-chevron-down");
    });

    // Socket event handlers: Update participants on connect/disconnect
    socket.on("existing-participants", (users) => {
      users.forEach((user) => {
        participants[user.socketId] = user;
      });
      renderParticipants();
    });

    socket.on("user-connected", (user) => {
      participants[user.socketId] = user;
      renderParticipants();
    });

    socket.on("user-disconnected", (socketId) => {
      delete participants[socketId];
      renderParticipants();
      const videoContainer = document.getElementById("container-video-" + socketId);
      if (videoContainer) videoContainer.remove();
    });

    // Record Button functionality
    const recordingBtn = document.getElementById("start-recording-btn");
    const recordingIcon = document.getElementById("recording-icon");
    const recordingLabel = document.getElementById("recording-label");

    function checkRecordingSupport() {
      if (window.MediaRecorder && navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        recordingBtn.disabled = false;
        recordingBtn.title = "Start Recording";
      } else {
        recordingBtn.disabled = true;
        recordingBtn.title = "Recording not supported in your browser.";
      }
    }
    checkRecordingSupport();

    recordingBtn.addEventListener("click", async function () {
      if (!isRecording) {
        if (!localStream) {
          alert("Need webcam/mic access first!");
          return;
        }
        // Combine audio from local stream + screen share video if active
        if (screenShareStream) {
          combinedStream = new MediaStream([
            ...localStream.getTracks().filter((t) => t.kind === "audio"),
            ...screenShareStream.getTracks(),
          ]);
        } else {
          combinedStream = localStream;
        }
        recordedChunks = [];
        try {
          mediaRecorder = new MediaRecorder(combinedStream, { mimeType: "video/webm; codecs=vp8,opus" });
        } catch (e) {
          console.error("Recording initialization error", e);
          alert("Recording not supported in this format: " + e.message);
          return;
        }
        mediaRecorder.ondataavailable = (e) => {
          if (e.data.size > 0) recordedChunks.push(e.data);
        };
        mediaRecorder.onstop = function () {
          const blob = new Blob(recordedChunks, { type: "video/webm" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "meeting-recording.webm";
          document.body.appendChild(a);
          a.click();
          setTimeout(() => {
            URL.revokeObjectURL(url);
            a.remove();
          }, 10000);
          if (combinedStream !== localStream) combinedStream.getTracks().forEach((track) => track.stop());
        };
        mediaRecorder.start();
        isRecording = true;
        recordingIcon.className = "fas fa-stop icon";
        recordingLabel.textContent = "Stop";
        recordingBtn.title = "Stop Recording";
        recordingBtn.style.background = "#e53e3e";
      } else {
        mediaRecorder.stop();
        isRecording = false;
        recordingIcon.className = "fas fa-record-vinyl icon";
        recordingLabel.textContent = "Record";
        recordingBtn.title = "Start Recording";
        recordingBtn.style.background = "";
      }
    });

    // Media and Video setup
    async function startMedia() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        originalVideoTrack = localStream.getVideoTracks()[0];
        addVideoStream(myVideo, localStream, name + " (You)");
        participants[socket.id] = { name, socketId: socket.id, isAudioMuted: false, isVideoMuted: false };
        socket.emit("join-room", meetingId, name, false, false);
        renderParticipants();
      } catch (err) {
        alert(
          "Could not get access to your camera and microphone! Please ensure the site is on HTTPS and you have granted permissions."
        );
      }
    }

    startMedia();

    // Add video stream to UI
    function addVideoStream(videoElement, stream, userName) {
      const containerId = "container-" + videoElement.id;
      let videoContainer = document.getElementById(containerId);
      if (!videoContainer) {
        videoContainer = document.createElement("div");
        videoContainer.classList.add("video-container");
        videoContainer.id = containerId;
        const nameTag = document.createElement("div");
        nameTag.classList.add("name-tag");
        nameTag.textContent = userName;
        videoElement.srcObject = stream;
        videoElement.addEventListener("loadedmetadata", () => videoElement.play());
        videoElement.classList.add("video-participant");
        videoContainer.appendChild(videoElement);
        videoContainer.appendChild(nameTag);
        videoGrid.appendChild(videoContainer);
      } else {
        videoContainer.querySelector(".video-participant").srcObject = stream;
        videoContainer.querySelector(".name-tag").textContent = userName;
      }
    }

    // Chat message handlers
    function displayMessage(sender, message, isMe = false) {
      const messageElement = document.createElement("div");
      messageElement.classList.add("message");
      if (isMe) messageElement.style.textAlign = "right";

      const senderElement = document.createElement("div");
      senderElement.classList.add("sender");
      senderElement.textContent = isMe ? "You" : sender;

      const textElement = document.createElement("div");
      textElement.textContent = message;

      messageElement.appendChild(senderElement);
      messageElement.appendChild(textElement);
      document.getElementById("chat-messages").appendChild(messageElement);
      document.getElementById("chat-messages").scrollTop = document.getElementById("chat-messages").scrollHeight;
    }
    document.getElementById("send-chat-btn").addEventListener("click", () => {
      const message = document.getElementById("chat-input").value.trim();
      if (message) {
        displayMessage(name, message, true);
        socket.emit("chat-message", message, meetingId, name);
        document.getElementById("chat-input").value = "";
      }
    });
    document.getElementById("chat-input").addEventListener("keypress", function (e) {
      if (e.key === "Enter") document.getElementById("send-chat-btn").click();
    });

    // Copy meeting ID link function
    document.getElementById("copy-link-btn").addEventListener("click", function () {
      const meetingLink = window.location.href;
      navigator.clipboard
        .writeText(meetingLink)
        .then(() => {
          this.classList.add("copied");
          this.title = "Copied!";
          setTimeout(() => {
            this.classList.remove("copied");
            this.title = "Copy Meeting Link";
          }, 2000);
        })
        .catch((err) => console.error("Failed to copy text", err));
    });

    // End call handling
    document.getElementById("end-call-btn").addEventListener("click", function () {
      if (localStream) localStream.getTracks().forEach((t) => t.stop());
      if (screenShareStream) screenShareStream.getTracks().forEach((t) => t.stop());
      Object.values(peers).forEach((p) => p.close && p.close());
      socket.emit("leave-room", meetingId);
      window.location.href = "index.html";
    });
  </script>
</body>
</html>
