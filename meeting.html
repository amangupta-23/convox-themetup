    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>Convox Elite - Live Meeting</title>
        <script src="https://kit.fontawesome.com/a7b1b11b13.js" crossorigin="anonymous"></script>
        
        <script src="https://convox-themetup.onrender.com/socket.io/socket.io.js"></script>

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
        <style>
    body {
  font-family: Montserrat, sans-serif;
  background: #121212;
  color: #f0f0f0;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
}
header.navbar {
  background-color: rgba(26, 26, 26, 0.8);
  backdrop-filter: blur(10px);
  padding: 0.75rem 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #333;
  flex-shrink: 0;
}
.logo {
  font-size: 1.5rem;
  font-weight: 700;
  color: #fff;
  font-family: "Playfair Display", serif;
}
.main-content {
  display: flex;
  flex-grow: 1;
  overflow: hidden;
}
.video-area {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  padding: 20px;
  overflow-y: auto;
}
.meeting-info {
  text-align: center;
  margin-bottom: 20px;
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.meeting-info h1 {
  font-size: 1.75rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
}
.meeting-info p {
  color: #aaa;
  display: flex;
  align-items: center;
  gap: 8px;
}
.copy-btn {
  background: none;
  border: none;
  color: #3498db;
  cursor: pointer;
  font-size: 1rem;
  transition: color 0.2s ease;
}
.copy-btn:hover {
  color: #2980b9;
}
.copy-btn.copied {
  color: #27ae60;
}
#video-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 15px;
  width: 100%;
}
.video-container {
  position: relative;
  background-color: #000;
  border-radius: 12px;
  overflow: hidden;
  border: 2px solid transparent;
  transition: border-color 0.3s ease;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
  aspect-ratio: 16 / 9;
}
.video-container:hover {
  border-color: #3498db;
}
video.video-participant {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}
.name-tag {
  position: absolute;
  bottom: 8px;
  left: 8px;
  background-color: rgba(0, 0, 0, 0.6);
  color: #fff;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.8rem;
  font-weight: 500;
  z-index: 10;
}
.audio-status {
  margin-right: 5px;
  color: #27ae60;
}
.audio-status.muted {
  color: #e74c3c;
}

/* -------- Stylish Sidebar & Content -------- */
.sidebar {
  background: linear-gradient(135deg, #191970 0%, #262626 100%);
  box-shadow: 0 2px 18px rgba(10,20,60,0.17);
  border-left: 1px solid #324076;
  display: flex;
  flex-direction: column;
  height: 100%;
}
.sidebar-content, .chat-box {
  flex: 1 1 50%;
  min-height: 0;
  max-height: 50vh;
  overflow-y: auto;
  padding: 1.1rem 0.9rem;
}
.sidebar-header, .chat-header {
  background: rgba(25, 25, 112, 0.33);
  border-radius: 8px 8px 0 0;
  margin-bottom: 0.4rem;
  padding-bottom: 0.3rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.sidebar-header h2, .chat-header span {
  color: #49aaff;
  letter-spacing: 1.2px;
  font-weight: 800;
  font-size: 1.22rem;
}
#participants-count {
  background: #1fadf6;
  color: #fff;
  font-size: 1.05rem;
  padding: 0 10px;
  margin-left: 8px;
  border-radius: 14px;
  font-weight: 700;
}
#participants-list {
  list-style: none;
  padding: 0;
  margin: 0;
}
#participants-list li {
  background: rgba(35,45,100,0.11);
  margin-bottom: 7px;
  padding: 8px 12px;
  border-radius: 6px;
  color: #e9e9ff;
  font-weight: 600;
  font-size: 1.0rem;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: 0 1px 6px rgba(20,30,60,0.07);
  border: none;
  transition: background 0.21s;
}
#participants-list li:hover {
  background: #2359af;
  color: #fff;
}
.messages {
  background: rgba(19,34,64,0.12);
  border-radius: 8px;
  margin-bottom: 4px;
  padding: 1.1rem 0.8rem;
  box-shadow: 0 1px 8px rgba(0,0,0,0.08);
  overflow-y: auto;
}
.message {
  margin-bottom: 0.75rem;
  background: #222;
  padding: 0.5rem;
  border-radius: 8px;
  font-size: 1.01rem;
}
.message .sender {
  font-weight: 700;
  color: #1fadf6;
  font-size: 0.92rem;
  margin-bottom: 4px;
  letter-spacing: .03em;
}
.chat-input {
  display: flex;
  padding: 1rem 0.1rem;
  background: #191970;
  border-top: 1px solid #333;
  border-radius: 0 0 8px 8px;
}
.chat-input input {
  background: #193155;
  color: #e0ecff;
  border: 1.5px solid #223f6a;
  font-size: 1.05rem;
  flex-grow: 1;
  border-radius: 6px;
  padding: 0.6rem 0.9rem;
  margin-right: 8px;
}
.chat-input button {
  background: #2bb6f9;
  font-weight: 700;
  border-radius: 8px;
  border: none;
  color: #fff;
  padding: 0.5rem 1.2rem;
  cursor: pointer;
  transition: background 0.2s;
}
.chat-input button:hover {
  background: #1fa1dd;
}
/* -------- Controls at bottom -------- */
.controls {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 1rem;
  background: rgba(30, 30, 30, 0.85);
  border-radius: 50px;
  padding: 0.75rem 1.5rem;
  border: 1px solid #444;
  z-index: 1000;
}
.controls button {
  background: #4b4b4b;
  border: none;
  width: 55px;
  height: 55px;
  border-radius: 50%;
  color: #fff;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}
.controls button:hover {
  background: #6a6a6a;
  transform: translateY(-3px);
}
/* Disabled style for controls */
.controls button:disabled {
  background: #2a2a2a;
  cursor: not-allowed;
  opacity: 0.6;
}
/* Controls for off-state e.g mic muted */
.controls button[aria-pressed="false"] {
  background-color: #cc3333;
}
.controls button[aria-pressed="false"]:hover {
  background-color: #e54545;
}
.controls .icon {
  font-size: 1.3rem;
  margin-bottom: 4px;
}
.controls .label {
  font-size: 0.6rem;
  font-weight: 600;
  text-transform: uppercase;
}
.end-call-btn {
  background: #e53e3e;
}
.end-call-btn:hover {
  background: #c53030;
}

  </style>
    </head>
    <body>
        <header class="navbar">
            <div class="logo">Convox Elite</div>
        </header>

        <div class="main-content">
            <main class="video-area">
                <div class="meeting-info">
                    <h1>Live Meeting</h1>
                    <p>
                        Meeting ID: <strong id="meeting-id-display"></strong>
                        <button id="copy-link-btn" class="copy-btn" title="Copy Meeting Link">
                            <i class="far fa-copy"></i>
                        </button>
                    </p>
                </div>
                <div id="video-grid">
                </div>
            </main>

            <aside class="sidebar">
              <!-- Participants Section -->
              <div class="sidebar-content collapsible" id="participants-section">
                <div class="sidebar-header">
                  <h2>Participants</h2>
                  <button class="toggle-btn" id="toggle-participants-btn" title="Minimize/Maximize">
                    <i class="fas fa-chevron-up"></i>
                  </button>
                </div>
                <ul id="participants-list"></ul>
              </div>
          
              <!-- Messages/Chat Section -->
              <div class="chat-box collapsible" id="messages-section">
                <div class="chat-header">
                  <span>Messages</span>
                  <button class="toggle-btn" id="toggle-messages-btn" title="Minimize/Maximize">
                    <i class="fas fa-chevron-up"></i>
                  </button>
                </div>
                <div class="messages" id="chat-messages"></div>
                <div class="chat-input">
                  <input type="text" id="chat-input" placeholder="Send a message...">
                  <button id="send-chat-btn"><i class="fas fa-paper-plane"></i></button>
                </div>
              </div>
            </aside>

        </div>

        <div class="controls" role="toolbar" aria-label="Meeting controls">
            <button id="toggle-audio-btn" title="Toggle Audio" aria-pressed="true">
                <i id="audio-icon" class="fas fa-microphone icon"></i>
                <span id="audio-label" class="label">Mute</span>
            </button>
            <button id="toggle-video-btn" title="Toggle Video" aria-pressed="true">
                <i id="video-icon" class="fas fa-video icon"></i>
                <span id="video-label" class="label">Stop</span>
            </button>
            <button id="toggle-screen-share-btn" title="Screen Share" aria-pressed="false">
                <i id="screenshare-icon" class="fas fa-desktop icon"></i>
                <span id="screenshare-label" class="label">Share</span>
            </button>
            <button id="start-recording-btn" title="Start Recording" aria-pressed="false" disabled>
                <i id="recording-icon" class="fas fa-record-vinyl icon"></i>
                <span id="recording-label" class="label">Record</span>
            </button>
            <button id="end-call-btn" title="End Call">
                <i class="fas fa-phone-slash icon"></i>
                <span class="label">End</span>
            </button>
        </div>
     
        <script>
    Â  Â  Â  Â  const RTCSessionDescription = window.RTCSessionDescription || window.mozRTCSessionDescription || window.webkitRTCSessionDescription;
    Â  Â  Â  Â  const RTCIceCandidate = window.RTCIceCandidate || window.mozRTCIceCandidate || window.webkitRTCIceCandidate;

    Â  Â  Â  Â  const RENDER_BACKEND_URL = 'https://convox-themetup.onrender.com';
    Â  Â  Â  Â  const socket = io(RENDER_BACKEND_URL); 

    Â  Â  Â  Â  const videoGrid = document.getElementById('video-grid');
    Â  Â  Â  Â  const myVideo = document.createElement('video');
    Â  Â  Â  Â  myVideo.muted = true;
    Â  Â  Â  Â  myVideo.id = 'my-video';
    Â  Â  Â  Â  const peers = {};

    Â  Â  Â  Â  const urlParams = new URLSearchParams(window.location.search);
    Â  Â  Â  Â  const meetingId = urlParams.get('id');
    Â  Â  Â  Â  const name = localStorage.getItem('userName') || 'Guest';
    Â  Â  Â  Â  const email = localStorage.getItem('userEmail') || 'guest@example.com';
    Â  Â  Â  Â  
    Â  Â  Â  Â  document.getElementById('meeting-id-display').textContent = meetingId || 'N/A';

    Â  Â  Â  Â  const configuration = {
    Â  Â  Â  Â  Â  Â  iceServers: [
    Â  Â  Â  Â  Â  Â  Â  Â  { urls: 'stun:stun.l.google.com:19302' }
    Â  Â  Â  Â  Â  Â  ]
    Â  Â  Â  Â  };

    Â  Â  Â  Â  let localStream;
    Â  Â  Â  Â  let screenShareStream = null;
    Â  Â  Â  Â  let originalVideoTrack;
    Â  Â  Â  Â  const participants = {};

    Â  Â  Â  Â  // Core Functions

    Â  Â  Â  Â  function addVideoStream(videoElement, stream, userName) {
    Â  Â  Â  Â  Â  Â  const videoId = videoElement.id;
    Â  Â  Â  Â  Â  Â  const containerId = `container-${videoId}`;
    Â  Â  Â  Â  Â  Â  
    Â  Â  Â  Â  Â  Â  const existingContainer = document.getElementById(containerId);
    Â  Â  Â  Â  Â  Â  
    Â  Â  Â  Â  Â  Â  if (existingContainer) {
    Â  Â  Â  Â  Â  Â  Â  Â  existingContainer.querySelector('.video-participant').srcObject = stream;
    Â  Â  Â  Â  Â  Â  Â  Â  const nameTagEl = existingContainer.querySelector('.name-tag');
    Â  Â  Â  Â  Â  Â  Â  Â  if(nameTagEl) nameTagEl.textContent = userName;
    Â  Â  Â  Â  Â  Â  Â  Â  return;
    Â  Â  Â  Â  Â  Â  }

    Â  Â  Â  Â  Â  Â  const videoContainer = document.createElement('div');
    Â  Â  Â  Â  Â  Â  videoContainer.classList.add('video-container');
    Â  Â  Â  Â  Â  Â  videoContainer.id = containerId; 

    Â  Â  Â  Â  Â  Â  const nameTag = document.createElement('div');
    Â  Â  Â  Â  Â  Â  nameTag.classList.add('name-tag');
    Â  Â  Â  Â  Â  Â  nameTag.textContent = userName;

    Â  Â  Â  Â  Â  Â  videoElement.srcObject = stream;
    Â  Â  Â  Â  Â  Â  videoElement.addEventListener('loadedmetadata', () => {
    Â  Â  Â  Â  Â  Â  Â  Â  videoElement.play();
    Â  Â  Â  Â  Â  Â  });
    Â  Â  Â  Â  Â  Â  videoElement.classList.add('video-participant');

    Â  Â  Â  Â  Â  Â  videoContainer.append(videoElement);
    Â  Â  Â  Â  Â  Â  videoContainer.append(nameTag);
    Â  Â  Â  Â  Â  Â  
    Â  Â  Â  Â  Â  Â  videoGrid.append(videoContainer);
    Â  Â  Â  Â  }

    Â  Â  Â  Â  function createPeerConnection(targetSocketId) {
    Â  Â  Â  Â  Â  Â  if (peers[targetSocketId]) {
    Â  Â  Â  Â  Â  Â  Â  Â  console.warn(`Peer connection already exists for ${targetSocketId}.`);
    Â  Â  Â  Â  Â  Â  Â  Â  return peers[targetSocketId];
    Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  Â  Â  
    Â  Â  Â  Â  Â  Â  const peer = new RTCPeerConnection(configuration);
    Â  Â  Â  Â  Â  Â  peers[targetSocketId] = peer;

    Â  Â  Â  Â  Â  Â  if (localStream) {
    Â  Â  Â  Â  Â  Â  Â  Â  localStream.getTracks().forEach(track => {
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  peer.addTrack(track, localStream);
    Â  Â  Â  Â  Â  Â  Â  Â  });
    Â  Â  Â  Â  Â  Â  }

    Â  Â  Â  Â  Â  Â  peer.ontrack = (event) => {
    Â  Â  Â  Â  Â  Â  Â  Â  const stream = event.streams[0];
    Â  Â  Â  Â  Â  Â  Â  Â  const remoteVideoId = `video-${targetSocketId}`;
    Â  Â  Â  Â  Â  Â  Â  Â  let remoteVideo = document.getElementById(remoteVideoId);

    Â  Â  Â  Â  Â  Â  Â  Â  if (!stream || stream.getTracks().length === 0) {
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn(`Received empty stream from ${targetSocketId}.`);
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return; 
    Â  Â  Â  Â  Â  Â  Â  Â  }

    Â  Â  Â  Â  Â  Â  Â  Â  if (!remoteVideo) {
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  remoteVideo = document.createElement('video');
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  remoteVideo.id = remoteVideoId;
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  remoteVideo.classList.add('remote-video');
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  remoteVideo.muted = false;
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const remoteUserName = participants[targetSocketId]?.name || 'Guest';
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addVideoStream(remoteVideo, stream, remoteUserName); 
    Â  Â  Â  Â  Â  Â  Â  Â  } else {
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  remoteVideo.srcObject = stream;
    Â  Â  Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  Â  Â  Â  Â  console.log(`âœ… Remote stream from ${targetSocketId} received/updated.`);
    Â  Â  Â  Â  Â  Â  };

    Â  Â  Â  Â  Â  Â  peer.onicecandidate = (event) => {
    Â  Â  Â  Â  Â  Â  Â  Â  if (event.candidate) {
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  socket.emit('ice-candidate', {
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  candidate: event.candidate,
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toSocketId: targetSocketId
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
    Â  Â  Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  Â  Â  };
    Â  Â  Â  Â  Â  Â  
    Â  Â  Â  Â  Â  Â  return peer;
    Â  Â  Â  Â  }

    Â  Â  Â  Â  function replaceTrack(newTrack, kind) {
    Â  Â  Â  Â  Â  Â  Object.values(peers).forEach(peer => {
    Â  Â  Â  Â  Â  Â  Â  Â  const sender = peer.getSenders().find(s => s.track && s.track.kind === kind);
    Â  Â  Â  Â  Â  Â  Â  Â  
    Â  Â  Â  Â  Â  Â  Â  Â  if (sender) {
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sender.replaceTrack(newTrack)
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(() => console.log(`Track replaced successfully for peer.`))
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .catch(err => console.error(`Error replacing ${kind} track:`, err));
    Â  Â  Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  Â  Â  });
    Â  Â  Â  Â  }


    Â  Â  Â  Â  async function startMedia(meetingId, name, email) {
    Â  Â  Â  Â  Â  Â  if (!meetingId || !name || !email) {
    Â  Â  Â  Â  Â  Â  Â  Â  return console.error("Missing meeting details.");
    Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  Â  Â  try {
    Â  Â  Â  Â  Â  Â  Â  Â  localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    Â  Â  Â  Â  Â  Â  Â  Â  originalVideoTrack = localStream.getVideoTracks()[0];
    Â  Â  Â  Â  Â  Â  Â  Â  addVideoStream(myVideo, localStream, name + ' (You)');
    Â  Â  Â  Â  Â  Â  Â  Â  
    Â  Â  Â  Â  Â  Â  Â  Â  participants[socket.id] = { 
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name, 
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  email, 
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  socketId: socket.id,
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isAudioMuted: false,
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isVideoMuted: false
    Â  Â  Â  Â  Â  Â  Â  Â  };
    Â  Â  Â  Â  Â  Â  Â  Â  
    Â  Â  Â  Â  Â  Â  Â  Â  socket.emit('join-room', { 
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  meetingId, 
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name, 
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  email,
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isAudioMuted: !localStream.getAudioTracks()[0]?.enabled,
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isVideoMuted: !localStream.getVideoTracks()[0]?.enabled
    Â  Â  Â  Â  Â  Â  Â  Â  });
    Â  Â  Â  Â  Â  Â  Â  Â  renderParticipants();

    Â  Â  Â  Â  Â  Â  } catch (err) {
    Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Error accessing media:', err);
    Â  Â  Â  Â  Â  Â  Â  Â  alert('Could not get access to your camera and microphone! Please ensure the site is on HTTPS and you have granted permissions.');
    Â  Â  Â  Â  Â  Â  Â  Â  toggleAudioBtn.disabled = true;
    Â  Â  Â  Â  Â  Â  Â  Â  toggleVideoBtn.disabled = true;
    Â  Â  Â  Â  Â  Â  Â  Â  toggleScreenShareBtn.disabled = true;
    Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  }
    Â  Â  Â  Â  
    Â  Â  Â  Â  // UI and Controls Logic
    Â  Â  Â  Â  const participantsList = document.getElementById('participants');
    Â  Â  Â  Â  const toggleAudioBtn = document.getElementById('toggle-audio-btn');
    Â  Â  Â  Â  const toggleVideoBtn = document.getElementById('toggle-video-btn');
    Â  Â  Â  Â  const toggleScreenShareBtn = document.getElementById('toggle-screen-share-btn');
    Â  Â  Â  Â  const endCallBtn = document.getElementById('end-call-btn');
    Â  Â  Â  Â  const audioIcon = document.getElementById('audio-icon');
    Â  Â  Â  Â  const audioLabel = document.getElementById('audio-label');
    Â  Â  Â  Â  const videoIcon = document.getElementById('video-icon');
    Â  Â  Â  Â  const videoLabel = document.getElementById('video-label');
    Â  Â  Â  Â  const screenshareIcon = document.getElementById('screenshare-icon');
    Â  Â  Â  Â  const screenshareLabel = document.getElementById('screenshare-label');
    Â  Â  Â  Â  
    Â  Â  Â  Â  const chatMessages = document.getElementById('chat-messages');
    Â  Â  Â  Â  const chatInput = document.getElementById('chat-input');
    Â  Â  Â  Â  const sendChatBtn = document.getElementById('send-chat-btn');

    Â  Â  Â  Â  function updateControlButton(btn, iconEl, labelEl, state, activeIcon, inactiveIcon, activeLabel, inactiveLabel) {
    Â  Â  Â  Â  Â  Â  btn.setAttribute('aria-pressed', state);
    Â  Â  Â  Â  Â  Â  iconEl.className = state ? `${activeIcon} icon` : `${inactiveIcon} icon`;
    Â  Â  Â  Â  Â  Â  labelEl.textContent = state ? activeLabel : inactiveLabel;
    Â  Â  Â  Â  }

    Â  Â  Â  Â  function renderParticipants(){
    Â  Â  Â  Â  Â  Â  participantsList.innerHTML='';
    Â  Â  Â  Â  Â  Â  Object.values(participants).forEach(u => {
    Â  Â  Â  Â  Â  Â  Â  Â  const li = document.createElement('li');
    Â  Â  Â  Â  Â  Â  Â  Â  const audioIcon = document.createElement('i');
    Â  Â  Â  Â  Â  Â  Â  Â  audioIcon.classList.add('fas');
    Â  Â  Â  Â  Â  Â  Â  Â  audioIcon.classList.add(u.isAudioMuted ? 'fa-microphone-slash' : 'fa-microphone');
    Â  Â  Â  Â  Â  Â  Â  Â  audioIcon.style.color = u.isAudioMuted ? '#e74c3c' : '#2ecc71';
    Â  Â  Â  Â  Â  Â  Â  Â  
    Â  Â  Â  Â  Â  Â  Â  Â  const videoIcon = document.createElement('i');
    Â  Â  Â  Â  Â  Â  Â  Â  videoIcon.classList.add('fas');
    Â  Â  Â  Â  Â  Â  Â  Â  videoIcon.classList.add(u.isVideoMuted ? 'fa-video-slash' : 'fa-video');
    Â  Â  Â  Â  Â  Â  Â  Â  videoIcon.style.color = u.isVideoMuted ? '#e74c3c' : '#2ecc71';
    Â  Â  Â  Â  Â  Â  Â  Â  
    Â  Â  Â  Â  Â  Â  Â  Â  li.appendChild(audioIcon);
    Â  Â  Â  Â  Â  Â  Â  Â  li.appendChild(videoIcon);
    Â  Â  Â  Â  Â  Â  Â  Â  li.innerHTML += `<span>${u.name} ${u.socketId === socket.id ? '(You)' : ''}</span>`;
    Â  Â  Â  Â  Â  Â  Â  Â  participantsList.appendChild(li);
    Â  Â  Â  Â  Â  Â  });
    Â  Â  Â  Â  }

    Â  Â  Â  Â  toggleAudioBtn.addEventListener('click', ()=>{
    Â  Â  Â  Â  Â  Â  if(!localStream) return;
    Â  Â  Â  Â  Â  Â  const track = localStream.getAudioTracks()[0];
    Â  Â  Â  Â  Â  Â  if (!track) return;

    Â  Â  Â  Â  Â  Â  track.enabled = !track.enabled;
    Â  Â  Â  Â  Â  Â  const isEnabled = track.enabled;
    Â  Â  Â  Â  Â  Â  
    Â  Â  Â  Â  Â  Â  updateControlButton(
    Â  Â  Â  Â  Â  Â  Â  Â  toggleAudioBtn, 
    Â  Â  Â  Â  Â  Â  Â  Â  audioIcon, 
    Â  Â  Â  Â  Â  Â  Â  Â  audioLabel, 
    Â  Â  Â  Â  Â  Â  Â  Â  isEnabled, 
    Â  Â  Â  Â  Â  Â  Â  Â  'fas fa-microphone', 
    Â  Â  Â  Â  Â  Â  Â  Â  'fas fa-microphone-slash', 
    Â  Â  Â  Â  Â  Â  Â  Â  'Mute', 
    Â  Â  Â  Â  Â  Â  Â  Â  'Unmute'
    Â  Â  Â  Â  Â  Â  );
    Â  Â  Â  Â  Â  Â  socket.emit('user-status-change', { 
    Â  Â  Â  Â  Â  Â  Â  Â  statusType: 'audio', 
    Â  Â  Â  Â  Â  Â  Â  Â  isMuted: !isEnabled,
    Â  Â  Â  Â  Â  Â  Â  Â  meetingId: meetingId
    Â  Â  Â  Â  Â  Â  });
    Â  Â  Â  Â  });

    Â  Â  Â  Â  toggleVideoBtn.addEventListener('click', ()=>{
    Â  Â  Â  Â  Â  Â  if(!localStream) return;
    Â  Â  Â  Â  Â  Â  const track = localStream.getVideoTracks()[0];
    Â  Â  Â  Â  Â  Â  if (!track) return;
    Â  Â  Â  Â  Â  Â  
    Â  Â  Â  Â  Â  Â  track.enabled = !track.enabled;
    Â  Â  Â  Â  Â  Â  const isEnabled = track.enabled;
    Â  Â  Â  Â  Â  Â  
    Â  Â  Â  Â  Â  Â  updateControlButton(
    Â  Â  Â  Â  Â  Â  Â  Â  toggleVideoBtn, 
    Â  Â  Â  Â  Â  Â  Â  Â  videoIcon, 
    Â  Â  Â  Â  Â  Â  Â  Â  videoLabel, 
    Â  Â  Â  Â  Â  Â  Â  Â  isEnabled, 
    Â  Â  Â  Â  Â  Â  Â  Â  'fas fa-video', 
    Â  Â  Â  Â  Â  Â  Â  Â  'fas fa-video-slash', 
    Â  Â  Â  Â  Â  Â  Â  Â  'Stop', 
    Â  Â  Â  Â  Â  Â  Â  Â  'Start'
    Â  Â  Â  Â  Â  Â  );
    Â  Â  Â  Â  Â  Â  socket.emit('user-status-change', { 
    Â  Â  Â  Â  Â  Â  Â  Â  statusType: 'video', 
    Â  Â  Â  Â  Â  Â  Â  Â  isMuted: !isEnabled,
    Â  Â  Â  Â  Â  Â  Â  Â  meetingId: meetingId
    Â  Â  Â  Â  Â  Â  });
    Â  Â  Â  Â  });

    Â  Â  Â  Â  toggleScreenShareBtn.addEventListener('click', async ()=>{
    Â  Â  Â  Â  Â  Â  if(!localStream) return alert('Start camera/mic first.');
    Â  Â  Â  Â  Â  Â  
    Â  Â  Â  Â  Â  Â  const isScreenSharing = screenShareStream !== null;

    Â  Â  Â  Â  Â  Â  if(isScreenSharing){
    Â  Â  Â  Â  Â  Â  Â  Â  screenShareStream.getTracks().forEach(t=>t.stop());
    Â  Â  Â  Â  Â  Â  Â  Â  screenShareStream = null;
    Â  Â  Â  Â  Â  Â  Â  Â  myVideo.srcObject = localStream;
    Â  Â  Â  Â  Â  Â  Â  Â  replaceTrack(originalVideoTrack, 'video');
    Â  Â  Â  Â  Â  Â  Â  Â  toggleVideoBtn.disabled=false;
    Â  Â  Â  Â  Â  Â  Â  Â  updateControlButton(
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toggleScreenShareBtn, 
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  screenshareIcon, 
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  screenshareLabel, 
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  false, 
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'fas fa-stop-circle',
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'fas fa-desktop',
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Stop', 
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Share'
    Â  Â  Â  Â  Â  Â  Â  Â  );
    Â  Â  Â  Â  Â  Â  } else {
    Â  Â  Â  Â  Â  Â  Â  Â  try{
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  screenShareStream = await navigator.mediaDevices.getDisplayMedia({
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  video: true,
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  audio: false
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const screenVideoTrack = screenShareStream.getVideoTracks()[0];
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  screenVideoTrack.onended = () => {
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(screenShareStream) toggleScreenShareBtn.click(); 
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myVideo.srcObject = screenShareStream;
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  replaceTrack(screenVideoTrack, 'video');
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toggleVideoBtn.disabled=true;
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateControlButton(
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toggleScreenShareBtn, 
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  screenshareIcon, 
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  screenshareLabel, 
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  true, 
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'fas fa-stop-circle',
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'fas fa-desktop',
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Stop', 
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Share'
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  );
    Â  Â  Â  Â  Â  Â  Â  Â  }catch(err){
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error starting screen share:', err);
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('Cannot share screen. Permissions denied or operation cancelled.');
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  screenShareStream = null; 
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toggleScreenShareBtn.setAttribute('aria-pressed', false);
    Â  Â  Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  });

    Â  Â  Â  Â  endCallBtn.addEventListener('click', ()=>{
    Â  Â  Â  Â  Â  Â  if(localStream) localStream.getTracks().forEach(t=>t.stop());
    Â  Â  Â  Â  Â  Â  if(screenShareStream) screenShareStream.getTracks().forEach(t=>t.stop());
    Â  Â  Â  Â  Â  Â  
    Â  Â  Â  Â  Â  Â  Object.values(peers).forEach(p => p.close());
    Â  Â  Â  Â  Â  Â  socket.emit('leave-room', meetingId); 
    Â  Â  Â  Â  Â  Â  window.location.href='index.html';
    Â  Â  Â  Â  });
    Â  Â  Â  Â  
    Â  Â  Â  Â  const copyLinkBtn = document.getElementById('copy-link-btn');
    Â  Â  Â  Â  copyLinkBtn.addEventListener('click', () => {
    Â  Â  Â  Â  Â  Â  const meetingLink = window.location.href;
    Â  Â  Â  Â  Â  Â  navigator.clipboard.writeText(meetingLink).then(() => {
    Â  Â  Â  Â  Â  Â  Â  Â  copyLinkBtn.classList.add('copied');
    Â  Â  Â  Â  Â  Â  Â  Â  copyLinkBtn.title = 'Copied!';
    Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  copyLinkBtn.classList.remove('copied');
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  copyLinkBtn.title = 'Copy Meeting Link';
    Â  Â  Â  Â  Â  Â  Â  Â  }, 2000);
    Â  Â  Â  Â  Â  Â  }).catch(err => {
    Â  Â  Â  Â  Â  Â  Â  Â  console.error('Failed to copy text:', err);
    Â  Â  Â  Â  Â  Â  });
    Â  Â  Â  Â  });

    Â  Â  Â  Â  sendChatBtn.addEventListener('click', () => sendMessage());
    Â  Â  Â  Â  chatInput.addEventListener('keypress', (e) => {
    Â  Â  Â  Â  Â  Â  if (e.key === 'Enter') {
    Â  Â  Â  Â  Â  Â  Â  Â  sendMessage();
    Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  });

    Â  Â  Â  Â  function sendMessage() {
    Â  Â  Â  Â  Â  Â  const message = chatInput.value.trim();
    Â  Â  Â  Â  Â  Â  if (message) {
    Â  Â  Â  Â  Â  Â  Â  Â  displayMessage(name, message, true);
    Â  Â  Â  Â  Â  Â  Â  Â  socket.emit('chat-message', { message, meetingId, senderName: name });
    Â  Â  Â  Â  Â  Â  Â  Â  chatInput.value = '';
    Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  }

    Â  Â  Â  Â  function displayMessage(sender, message, isMe = false) {
    Â  Â  Â  Â  Â  Â  const messageElement = document.createElement('div');
    Â  Â  Â  Â  Â  Â  messageElement.classList.add('message');
    Â  Â  Â  Â  Â  Â  if (isMe) {
    Â  Â  Â  Â  Â  Â  Â  Â  messageElement.style.textAlign = 'right';
    Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  Â  Â  const senderElement = document.createElement('div');
    Â  Â  Â  Â  Â  Â  senderElement.classList.add('sender');
    Â  Â  Â  Â  Â  Â  senderElement.textContent = isMe ? 'You' : sender;
    Â  Â  Â  Â  Â  Â  const textElement = document.createElement('div');
    Â  Â  Â  Â  Â  Â  textElement.textContent = message;

    Â  Â  Â  Â  Â  Â  messageElement.appendChild(senderElement);
    Â  Â  Â  Â  Â  Â  messageElement.appendChild(textElement);
    Â  Â  Â  Â  Â  Â  chatMessages.appendChild(messageElement);
    Â  Â  Â  Â  Â  Â  chatMessages.scrollTop = chatMessages.scrollHeight;
    Â  Â  Â  Â  }

    Â  Â  Â  Â  // Socket.IO Signaling Handlers
    Â  Â  Â  Â  socket.on('existing-participants', async (existingParticipants) => {
    Â  Â  Â  Â  Â  Â  console.log('Existing users found:', existingParticipants);
    Â  Â  Â  Â  Â  Â  existingParticipants.forEach(async (participant) => {
    Â  Â  Â  Â  Â  Â  Â  Â  const targetSocketId = participant.socketId;
    Â  Â  Â  Â  Â  Â  Â  Â  if (!participants[targetSocketId]) {
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  participants[targetSocketId] = participant; 
    Â  Â  Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  Â  Â  Â  Â  const peer = createPeerConnection(targetSocketId);
    Â  Â  Â  Â  Â  Â  Â  Â  try {
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const offer = await peer.createOffer();
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await peer.setLocalDescription(offer);
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  socket.emit('call-user', { offer: offer, toSocketId: targetSocketId });
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`ðŸ“ž Sending call offer to: ${participant.name} (${targetSocketId})`);
    Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error creating or sending offer:", error);
    Â  Â  Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  Â  Â  });
    Â  Â  Â  Â  Â  Â  renderParticipants();
    Â  Â  Â  Â  });

    Â  Â  Â  Â  socket.on('user-connected', (user) => {
    Â  Â  Â  Â  Â  Â  console.log(`ðŸ‘¤ New user connected: ${user.name} (${user.socketId}). Preparing to receive call.`);
    Â  Â  Â  Â  Â  Â  if (!participants[user.socketId]) {
    Â  Â  Â  Â  Â  Â  Â  Â  participants[user.socketId] = user; 
    Â  Â  Â  Â  Â  Â  Â  Â  renderParticipants();
    Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  Â  Â  createPeerConnection(user.socketId);
    Â  Â  Â  Â  });

    Â  Â  Â  Â  socket.on('user-status-change', ({ socketId, statusType, isMuted }) => {
    Â  Â  Â  Â  Â  Â  if (participants[socketId]) {
    Â  Â  Â  Â  Â  Â  Â  Â  if (statusType === 'audio') {
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  participants[socketId].isAudioMuted = isMuted;
    Â  Â  Â  Â  Â  Â  Â  Â  } else if (statusType === 'video') {
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  participants[socketId].isVideoMuted = isMuted;
    Â  Â  Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  Â  Â  Â  Â  renderParticipants();
    Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  });

    Â  Â  Â  Â  socket.on('chat-message', ({ senderName, message }) => {
    Â  Â  Â  Â  Â  Â  displayMessage(senderName, message);
    Â  Â  Â  Â  });

    Â  Â  Â  Â  socket.on('incoming-call', async ({ offer, from, fromName }) => {
    Â  Â  Â  Â  Â  Â  console.log(`Incoming call from: ${fromName} (${from})`);
    Â  Â  Â  Â  Â  Â  let peer = createPeerConnection(from);
    Â  Â  Â  Â  Â  Â  try {
    Â  Â  Â  Â  Â  Â  Â  Â  await peer.setRemoteDescription(new RTCSessionDescription(offer));
    Â  Â  Â  Â  Â  Â  Â  Â  const answer = await peer.createAnswer();
    Â  Â  Â  Â  Â  Â  Â  Â  await peer.setLocalDescription(answer);
    Â  Â  Â  Â  Â  Â  Â  Â  socket.emit('make-answer', { answer: answer, toSocketId: from });
    Â  Â  Â  Â  Â  Â  Â  Â  console.log(`ðŸŽ™ï¸ Sending answer back to ${fromName}.`);
    Â  Â  Â  Â  Â  Â  } catch (error) {
    Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error handling incoming call:", error);
    Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  });

    Â  Â  Â  Â  socket.on('answer-made', async ({ answer, from }) => {
    Â  Â  Â  Â  Â  Â  const peer = peers[from];
    Â  Â  Â  Â  Â  Â  if (peer) {
    Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Answer received from ${from}. Setting remote description.`);
    Â  Â  Â  Â  Â  Â  Â  Â  try {
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await peer.setRemoteDescription(new RTCSessionDescription(answer));
    Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error setting answer as remote description:", error);
    Â  Â  Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  });

    Â  Â  Â  Â  socket.on('ice-candidate', async ({ candidate, from }) => {
    Â  Â  Â  Â  Â  Â  const peer = peers[from];
    Â  Â  Â  Â  Â  Â  if (peer && candidate) {
    Â  Â  Â  Â  Â  Â  Â  Â  try {
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await peer.addIceCandidate(new RTCIceCandidate(candidate));
    Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error adding received ICE candidate:', e);
    Â  Â  Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  });

    Â  Â  Â  Â  socket.on('user-disconnected', ({ socketId }) => {
    Â  Â  Â  Â  Â  Â  if (peers[socketId]) {
    Â  Â  Â  Â  Â  Â  Â  Â  peers[socketId].close(); 
    Â  Â  Â  Â  Â  Â  Â  Â  delete peers[socketId];
    Â  Â  Â  Â  Â  Â  Â  Â  delete participants[socketId];
    Â  Â  Â  Â  Â  Â  Â  Â  renderParticipants();
    Â  Â  Â  Â  Â  Â  Â  Â  const videoContainer = document.getElementById(`container-video-${socketId}`);
    Â  Â  Â  Â  Â  Â  Â  Â  if (videoContainer) {
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  videoContainer.remove();
    Â  Â  Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  Â  Â  Â  Â  console.log(`User ${socketId} disconnected. Video removed.`);
    Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  });

    Â  Â  Â  Â  if (meetingId && name && email) {
    Â  Â  Â  Â  Â  Â  startMedia(meetingId, name, email);
    Â  Â  Â  Â  } else {
    Â  Â  Â  Â  Â  Â  alert('Missing meeting details. Redirecting to home.');
    Â  Â  Â  Â  Â  Â  window.location.href = 'index.html'; 
    Â  Â  Â  Â  }

    // ---- Participants Toggle ----
    const toggleParticipantsBtn = document.getElementById('toggle-participants-btn');
    const participantsSectionElem = document.getElementById('participants-section');
    if (participantsSectionElem && toggleParticipantsBtn) {
      toggleParticipantsBtn.addEventListener('click', function() {
        participantsSectionElem.classList.toggle('collapsed');
        toggleParticipantsBtn.classList.toggle('collapsed');
        const icon = toggleParticipantsBtn.querySelector('i');
        icon.classList.toggle('fa-chevron-up');
        icon.classList.toggle('fa-chevron-down');
      });
    }

// ---- Messages Toggle ----
    const toggleMessagesBtn = document.getElementById('toggle-messages-btn');
    const messagesSectionElem = document.getElementById('messages-section');
    if (messagesSectionElem && toggleMessagesBtn) {
      toggleMessagesBtn.addEventListener('click', function() {
        messagesSectionElem.classList.toggle('collapsed');
        toggleMessagesBtn.classList.toggle('collapsed');
        const icon = toggleMessagesBtn.querySelector('i');
        icon.classList.toggle('fa-chevron-up');
        icon.classList.toggle('fa-chevron-down');
      });
    }

// ---- RECORD BUTTON FUNCTIONALITY ----
const recordingBtn = document.getElementById('start-recording-btn');
const recordingIcon = document.getElementById('recording-icon');
const recordingLabel = document.getElementById('recording-label');
let mediaRecorder = null;
let recordedChunks = [];
let isRecording = false;
let combinedStream = null;

if (recordingBtn && recordingIcon && recordingLabel) {
  if (window.MediaRecorder && navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    recordingBtn.disabled = false;
    recordingBtn.title = "Start Recording";
  } else {
    recordingBtn.disabled = true;
    recordingBtn.title = "Recording not supported in your browser.";
  }

  recordingBtn.addEventListener('click', async function() {
    if (!isRecording) {
      if (!window.localStream) {
        alert("Need webcam/mic access first!");
        return;
      }
      if (window.screenShareStream) {
        combinedStream = new MediaStream([
          ...window.localStream.getTracks().filter(track => track.kind === "audio"),
          ...window.screenShareStream.getTracks()
        ]);
      } else {
        combinedStream = window.localStream;
      }
      recordedChunks = [];
      try {
        mediaRecorder = new MediaRecorder(combinedStream, { mimeType: 'video/webm;codecs=vp8,opus' });
      } catch (e) {
        console.error("Recording initialization error: ", e);
        alert("Recording not supported in this format: " + e.message);
        return;
      }

      mediaRecorder.ondataavailable = function(e) {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };

      mediaRecorder.onstop = function() {
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'meeting-recording.webm';
        document.body.appendChild(a);
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 10000);
        a.remove();

        if (combinedStream !== window.localStream && combinedStream) {
          combinedStream.getTracks().forEach(track => track.stop());
        }
      };

      mediaRecorder.start();
      isRecording = true;
      recordingIcon.className = "fas fa-stop icon";
      recordingLabel.textContent = 'Stop';
      recordingBtn.title = "Stop Recording";
      recordingBtn.style.background = "#e53e3e";
    } else {
      mediaRecorder.stop();
      isRecording = false;
      recordingIcon.className = "fas fa-record-vinyl icon";
      recordingLabel.textContent = 'Record';
      recordingBtn.title = "Start Recording";
      recordingBtn.style.background = "";
    }
  });
}

        if (window.MediaRecorder && navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    Â  Â      recordingBtn.disabled = false;
    Â  Â      recordingBtn.title = "Start Recording";
        } else {
    Â  Â      recordingBtn.disabled = true;
    Â  Â      recordingBtn.title = "Recording not supported in your browser.";
        }

        recordingBtn.addEventListener('click', async function() {
    Â  Â      if (!isRecording) {
    Â  Â  Â  Â      if (!localStream) {
    Â  Â  Â  Â  Â  Â      alert("Need webcam/mic access first!");
    Â  Â  Â  Â  Â  Â      return;
    Â  Â  Â  Â      }
    Â  Â  Â  Â      if (screenShareStream) {
    Â  Â  Â  Â  Â  Â      combinedStream = new MediaStream([
    Â  Â  Â  Â  Â  Â  Â  Â      ...localStream.getTracks().filter(track => track.kind === "audio"), 
    Â  Â  Â  Â  Â  Â  Â  Â      ...screenShareStream.getTracks() // video track
    Â  Â  Â  Â  Â  Â      ]);
    Â  Â  Â  Â      } else {
    Â  Â  Â  Â  Â  Â      combinedStream = localStream;
    Â  Â  Â  Â      }
    Â  Â  Â  Â      recordedChunks = [];
    Â  Â  Â  Â      try {
    Â  Â  Â  Â  Â  Â      mediaRecorder = new MediaRecorder(combinedStream, { mimeType: 'video/webm;codecs=vp8,opus' });
    Â  Â  Â  Â      } catch (e) {
    Â  Â  Â  Â  Â  Â      console.error("Recording initialization error: ", e);
    Â  Â  Â  Â  Â  Â      alert("Recording not supported in this format: " + e.message);
    Â  Â  Â  Â  Â  Â      return;
    Â  Â  Â  Â      }
    Â  Â  Â  Â      
    Â  Â  Â  Â      mediaRecorder.ondataavailable = function(e) {
    Â  Â  Â  Â  Â  Â      if (e.data.size > 0) recordedChunks.push(e.data);
    Â  Â  Â  Â      };
    Â  Â  Â  Â      
    Â  Â  Â  Â      mediaRecorder.onstop = function() {
    Â  Â  Â  Â  Â  Â      const blob = new Blob(recordedChunks, { type: 'video/webm' });
    Â  Â  Â  Â  Â  Â      const url = URL.createObjectURL(blob);
    Â  Â  Â  Â  Â  Â      const a = document.createElement('a');
    Â  Â  Â  Â  Â  Â      a.href = url;
    Â  Â  Â  Â  Â  Â      a.download = 'meeting-recording.webm';
    Â  Â  Â  Â  Â  Â      document.body.appendChild(a);
    Â  Â  Â  Â  Â  Â      a.click();
    Â  Â  Â  Â  Â  Â      setTimeout(() => URL.revokeObjectURL(url), 10000);
    Â  Â  Â  Â  Â  Â      a.remove();
    Â  Â  Â  Â  Â  Â      
    Â  Â  Â  Â  Â  Â      if (combinedStream !== localStream && combinedStream) {
    Â  Â  Â  Â  Â  Â          combinedStream.getTracks().forEach(track => track.stop());
    Â  Â  Â  Â  Â  Â      }
    Â  Â  Â  Â      };
    Â  Â  Â  Â      
    Â  Â  Â  Â      mediaRecorder.start();
    Â  Â  Â  Â      isRecording = true;
    Â  Â  Â  Â      recordingIcon.className = "fas fa-stop icon";
    Â  Â  Â  Â      recordingLabel.textContent = 'Stop';
    Â  Â  Â  Â      recordingBtn.title = "Stop Recording";
    Â  Â  Â  Â      recordingBtn.style.background = "#e53e3e";
    Â  Â      } else {
    Â  Â  Â  Â      mediaRecorder.stop();
    Â  Â  Â  Â      isRecording = false;
    Â  Â  Â  Â      recordingIcon.className = "fas fa-record-vinyl icon";
    Â  Â  Â  Â      recordingLabel.textContent = 'Record';
    Â  Â  Â  Â      recordingBtn.title = "Start Recording";
    Â  Â  Â  Â      recordingBtn.style.background = "";
    Â  Â      }
        });
    Â  Â  </script>
    </body>
    </html>
    
